Import-Module Veeam.Backup.PowerShell -ErrorAction Stop
 
$results = @()
$cutoffDate = (Get-Date).AddDays(-7)
 

$backups = Get-VBRBackup | Where-Object {
    $_.JobType -in @(
        "VmBackup", "WindowsAgent", "LinuxAgent",
        "PerVmParentBackup", "SqlBackup", "SqlLogBackup", "BackupSync"
    )
}
 
foreach ($backup in $backups) {
    $jobName = $backup.JobName
    $jobType = $backup.JobType
 
    try {
        $restorePoints = Get-VBRRestorePoint -Backup $backup | Where-Object {
            $_.CreationTime -ge $cutoffDate
        }
 
        
        $latestPoints = $restorePoints | Group-Object Name | ForEach-Object {
            $_.Group | Sort-Object CreationTime -Descending | Select-Object -First 1
        }
 
        foreach ($rp in $latestPoints) {
            if ($rp.IsConsistent) {
                $status = "Success"
            } elseif ($rp.IsCorrupted) {
                $status = "Failed"
            } else {
                $status = "Warning"
            }
 
            $results += [PSCustomObject]@{
                JobName          = $jobName
                BackupType       = $jobType
                ObjectName       = $rp.Name
                LatestBackupTime = $rp.CreationTime
                Status           = $status
            }
        }
    } catch {
        continue
    }
}
 
$csvPath = "$env:USERPROFILE\Desktop\Veeam_Backup_Report_Days.csv"
$results | Sort-Object LatestBackupTime -Descending | Export-Csv -Path $csvPath -NoTypeInformation -Encoding UTF8
